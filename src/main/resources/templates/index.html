<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstaVideo - Premium Video & Image Downloader</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Image gallery styles */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 12px 0;
        }

        .image-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background: #1a1a2e;
            aspect-ratio: 1;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .image-item .img-download-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(5, 160, 129, 0.92);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .image-item .img-download-btn:hover {
            background: #04c49e;
        }

        .image-item .img-download-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .media-type-badge {
            display: inline-block;
            background: #05a081;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .download-all-btn {
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #05a081, #0077b6);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .download-all-btn:hover {
            opacity: 0.9;
        }

        .download-all-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .img-count-badge {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 512 512">
                    <rect width="512" height="512" rx="100" fill="#05a081" />
                    <path d="M150 150 L362 256 L150 362 Z" fill="white" />
                </svg>
                <span>InstaVideo</span>
            </div>
            <div class="nav-links">
                <a href="#">Explore</a>
                <a href="#">License</a>
                <button class="btn btn-primary">Join</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <section class="hero">
            <h1>The best free stock videos shared by talented creators.</h1>
            <div class="search-box">
                <input type="text" id="videoUrl" placeholder="Paste Instagram, TikTok, YouTube or Pexels URL here...">
                <button id="scrapeBtn" class="btn btn-search">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </div>
        </section>

        <section id="previewSection" class="preview-section hidden">
            <div class="preview-card">
                <div class="card-header">
                    <div class="author-info">
                        <div class="avatar" id="authorAvatar"></div>
                        <span id="authorName">Loading...</span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-outline">Collect</button>
                        <button class="btn btn-outline heart">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                </path>
                            </svg>
                        </button>
                        <!-- Download button shown only for video posts -->
                        <button id="downloadBtn" class="btn btn-success hidden">Free Download</button>
                    </div>
                </div>
                <div class="media-container">
                    <!-- Video preview (shown for video posts) -->
                    <video id="videoPreview" controls poster="" class="hidden"></video>
                    <!-- Single Image preview -->
                    <img id="imagePreview" src="" alt="Preview" class="hidden">
                    <!-- Image gallery (shown for image/carousel posts) -->
                    <div id="imageGallery" class="hidden">
                        <span id="mediaTypeBadge" class="media-type-badge"></span>
                        <p id="imgCountBadge" class="img-count-badge"></p>
                        <div id="imageGrid" class="image-gallery"></div>
                        <button id="downloadAllBtn" class="download-all-btn hidden">‚¨á Download All Images</button>
                    </div>
                </div>
                <div class="card-footer">
                    <h2 id="videoTitle"></h2>
                    <p id="videoDesc"></p>
                </div>
            </div>
        </section>

        <section id="loadingOverlay" class="loading-overlay hidden">
            <div class="spinner"></div>
            <p id="loadingMsg">Processing your request...</p>
        </section>
    </main>

    <div id="toast" class="toast hidden"></div>

    <script>
        const videoUrlInput = document.getElementById('videoUrl');
        const scrapeBtn = document.getElementById('scrapeBtn');
        const previewSection = document.getElementById('previewSection');
        const videoPreview = document.getElementById('videoPreview');
        const imagePreview = document.getElementById('imagePreview');
        const imageGallery = document.getElementById('imageGallery');
        const imageGrid = document.getElementById('imageGrid');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMsg = document.getElementById('loadingMsg');
        const toast = document.getElementById('toast');

        let storedCookies = '';
        let storedUA = '';
        let storedOrigin = '';
        let storedImageUrls = [];
        let storedMediaType = '';
        let storedVideoUrl = '';  // direct video stream URL from scraper

        function showToast(msg, isError = false) {
            toast.textContent = msg;
            toast.className = `toast ${isError ? 'error' : 'success'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }

        function setLoading(show, msg = 'Processing your request...') {
            loadingMsg.textContent = msg;
            loadingOverlay.classList.toggle('hidden', !show);
        }

        async function scrapeInfo() {
            const url = videoUrlInput.value.trim();
            if (!url) return showToast('Please paste a URL', true);

            setLoading(true, 'Fetching media info...');
            previewSection.classList.add('hidden');
            storedCookies = '';
            storedUA = '';
            storedOrigin = '';
            storedImageUrls = [];
            storedMediaType = '';
            storedVideoUrl = '';

            try {
                const response = await fetch('/api/video/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoUrl: url })
                });

                if (!response.ok) throw new Error('Failed to fetch info');
                const data = await response.json();

                storedCookies = data.cookies || '';
                storedUA = data.userAgent || '';
                storedOrigin = data.originUrl || url;
                storedImageUrls = data.imageUrls || [];
                storedMediaType = data.mediaType || 'video';
                storedVideoUrl = data.videoUrl || '';

                document.getElementById('authorName').textContent = data.authorName || 'Creator';
                document.getElementById('videoTitle').textContent = data.title || '';
                document.getElementById('videoDesc').textContent = data.description || '';

                // Reset visibility
                videoPreview.classList.add('hidden');
                imagePreview.classList.add('hidden');
                imageGallery.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                downloadAllBtn.classList.add('hidden');
                imageGrid.innerHTML = '';

                if (storedMediaType === 'video') {
                    // --- VIDEO POST ---
                    // Even if we can't play it directly (hidden .mp4), we can still download it via backend
                    if (data.videoUrl) {
                        videoPreview.src = data.videoUrl;
                        videoPreview.poster = data.thumbnailUrl || '';
                        videoPreview.classList.remove('hidden');
                    } else if (data.thumbnailUrl) {
                        // Show thumbnail preview if raw video URL is obfuscated
                        imagePreview.src = `/api/image/proxy?url=${encodeURIComponent(data.thumbnailUrl)}`;
                        imagePreview.classList.remove('hidden');
                    }
                    downloadBtn.classList.remove('hidden');
                    downloadBtn.textContent = 'Free Download Video';

                } else if (storedMediaType === 'image' && storedImageUrls.length === 1) {
                    // --- SINGLE IMAGE POST ---
                    imagePreview.src = `/api/image/proxy?url=${encodeURIComponent(storedImageUrls[0])}`;
                    imagePreview.classList.remove('hidden');

                    // Allow the main download button to download this single image
                    downloadBtn.classList.remove('hidden');
                    downloadBtn.textContent = 'Free Download Image';

                } else if ((storedMediaType === 'image' || storedMediaType === 'carousel') && storedImageUrls.length > 0) {
                    // --- CAROUSEL POST ---
                    imageGallery.classList.remove('hidden');

                    const badge = document.getElementById('mediaTypeBadge');
                    badge.textContent = storedMediaType === 'carousel' ? 'üì∏ Carousel Post' : 'üñº Image Gallery';

                    const countBadge = document.getElementById('imgCountBadge');
                    countBadge.textContent = `${storedImageUrls.length} image${storedImageUrls.length > 1 ? 's' : ''} found`;

                    // Render image grid
                    storedImageUrls.forEach((imgUrl, idx) => {
                        const item = document.createElement('div');
                        item.className = 'image-item';

                        const img = document.createElement('img');
                        img.src = `/api/image/proxy?url=${encodeURIComponent(imgUrl)}`;
                        img.alt = `Image ${idx + 1}`;
                        img.loading = 'lazy';
                        img.onerror = () => { img.src = data.thumbnailUrl || ''; };

                        const dlBtn = document.createElement('button');
                        dlBtn.className = 'img-download-btn';
                        dlBtn.textContent = `‚¨á ${idx + 1}`;
                        dlBtn.addEventListener('click', () => downloadSingleImage(imgUrl, idx, dlBtn));

                        item.appendChild(img);
                        item.appendChild(dlBtn);
                        imageGrid.appendChild(item);
                    });

                    if (storedImageUrls.length > 1) {
                        downloadAllBtn.classList.remove('hidden');
                    }

                } else {
                    // Fallback: show thumbnail if nothing else
                    if (data.thumbnailUrl) {
                        imagePreview.src = `/api/image/proxy?url=${encodeURIComponent(data.thumbnailUrl)}`;
                        imagePreview.classList.remove('hidden');
                    }
                    showToast('No downloadable high-res media found. Showing preview.', true);
                }

                previewSection.classList.remove('hidden');
                showToast('Media found!');
            } catch (err) {
                showToast(err.message, true);
            } finally {
                setLoading(false);
            }
        }

        // Helper: fetch one image from backend and trigger browser download
        async function triggerImageDownload(imageUrl, filename) {
            const response = await fetch('/api/image/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageUrl: imageUrl })
            });
            if (!response.ok) {
                const txt = await response.text().catch(() => '');
                throw new Error(`HTTP ${response.status} ${txt}`);
            }
            const blob = await response.blob();
            // Read filename from Content-Disposition if available
            const cd = response.headers.get('Content-Disposition') || '';
            const match = cd.match(/filename="?([^"]+)"?/);
            const finalName = match ? match[1] : filename;

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = finalName;
            document.body.appendChild(a);
            a.click();
            // Revoke after short delay to ensure download starts
            setTimeout(() => { window.URL.revokeObjectURL(url); a.remove(); }, 2000);
        }

        // Download a single image via backend
        async function downloadSingleImage(imageUrl, idx, btn) {
            btn.disabled = true;
            btn.textContent = '‚è≥';
            try {
                await triggerImageDownload(imageUrl, `instagram_image_${idx + 1}.jpg`);
                showToast(`Image ${idx + 1} downloaded!`);
            } catch (err) {
                showToast(`Image ${idx + 1} failed: ${err.message}`, true);
                console.error('downloadSingleImage error:', err);
            } finally {
                btn.disabled = false;
                btn.textContent = `‚¨á ${idx + 1}`;
            }
        }

        // Download all images one by one with delay to avoid browser popup blocking
        async function downloadAllImages() {
            downloadAllBtn.disabled = true;
            let success = 0;
            for (let i = 0; i < storedImageUrls.length; i++) {
                downloadAllBtn.textContent = `Downloading ${i + 1}/${storedImageUrls.length}...`;
                try {
                    await triggerImageDownload(storedImageUrls[i], `instagram_image_${i + 1}.jpg`);
                    success++;
                } catch (err) {
                    console.error(`Image ${i + 1} failed:`, err);
                }
                // Wait 2s between each download ‚Äî browsers block rapid-fire downloads
                if (i < storedImageUrls.length - 1) {
                    await new Promise(r => setTimeout(r, 2000));
                }
            }
            showToast(`Downloaded ${success}/${storedImageUrls.length} images!`, success < storedImageUrls.length);
            downloadAllBtn.disabled = false;
            downloadAllBtn.textContent = '‚¨á Download All Images';
        }

        // Video or Single Image download
        async function downloadVideo() {
            if (storedMediaType === 'image' && storedImageUrls.length === 1) {
                const btn = downloadBtn;
                btn.disabled = true;
                btn.textContent = 'Downloading...';
                try {
                    await triggerImageDownload(storedImageUrls[0], 'instagram_image.jpg');
                    showToast('Image downloaded to your PC!');
                } catch (err) {
                    showToast(err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Free Download Image';
                }
                return;
            }

            const url = videoUrlInput.value.trim();
            const fileName = videoPreview.src.split('/').pop().split('?')[0] || 'video.mp4';

            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Downloading...';

            try {
                const response = await fetch('/api/video/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        videoUrl: videoUrlInput.value.trim(),
                        directVideoUrl: storedVideoUrl,
                        cookies: storedCookies,
                        userAgent: storedUA,
                        originUrl: storedOrigin
                    })
                });

                if (!response.ok) throw new Error('Download failed');

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = fileName.endsWith('.mp4') ? fileName : `${fileName}.mp4`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                a.remove();

                showToast('Downloaded to your PC!');
            } catch (err) {
                showToast(err.message, true);
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Free Download';
            }
        }

        scrapeBtn.addEventListener('click', scrapeInfo);
        downloadBtn.addEventListener('click', downloadVideo);
        downloadAllBtn.addEventListener('click', downloadAllImages);
        videoUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') scrapeInfo();
        });
    </script>
</body>

</html>